NgÆ°á»i táº¡o há»“ sÆ¡ (Owner)
     |
     | --> MÃ£ hÃ³a file (AES) --> Upload lÃªn IPFS --> CID
     | --> MÃ£ hÃ³a AES key báº±ng publicKey cá»§a chÃ­nh Owner --> LÆ°u CID + AESKeyEncrypted lÃªn Blockchain
     |
     v
+------------------------------------+
|          Smart Contract            |
| (lÆ°u CID, AESKeyEncrypted, owner)  |
+------------------------------------+

NgÆ°á»i nháº­n yÃªu cáº§u quyá»n
     |
     v
Owner duyá»‡t --> Backend táº¡o accessNonce
     |
     v
Backend tÃ­nh sharedKey tá»« (accessNonce + publicKeyNgÆ°á»iNháº­n)
     |
     |--> proxyAESKey = AESKeyGá»‘c Ä‘Æ°á»£c mÃ£ hÃ³a láº¡i báº±ng sharedKey
     v
LÆ°u proxyAESKey vÃ  accessNonce (gáº¯n vá»›i user Ä‘Ã³) trong backend (hoáº·c gá»­i táº¡m thá»i)

Khi ngÆ°á»i nháº­n truy cáº­p:
     |
     v
NgÆ°á»i nháº­n gá»­i accessNonce + privateKey
     |
Backend dÃ¹ng accessNonce + privateKey Ä‘á»ƒ tÃ­nh sharedKey
     |
     v
Giáº£i mÃ£ proxyAESKey --> AESKeyGá»‘c
     |
     v
DÃ¹ng AESKeyGá»‘c giáº£i mÃ£ file tá»« IPFS --> Tráº£ vá» báº£n xem trá»±c tiáº¿p (PDF/áº£nh)

/*
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚       Chá»§ sá»Ÿ há»¯u (Grantor)  â”‚
                       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚
                       â”‚ AES key (gá»‘c)               â”‚
                       â”‚ PublicKey RSA, PrivateKey   â”‚
                       â”‚ PublicKey EC, PrivateKey    â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                        MÃ£ hÃ³a AES key báº±ng RSA (public)
                                    â–¼
                          LÆ°u AES key mÃ£ hÃ³a lÃªn Blockchain
                                    â”‚
                â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                â•‘        Khi cÃ³ ngÆ°á»i yÃªu cáº§u truy cáº­p â•‘
                â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚        Táº¡o nonce & sharedKey tá»« EC keypair         â”‚
        â”‚        grantKey(priv) + requestKey(pub)            â”‚
        â”‚         sharedKey = SHA256(ECDH + nonce)           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                          MÃ£ hÃ³a AES key báº±ng sharedKey
                                   â”‚
                          Gá»­i cho ngÆ°á»i yÃªu cáº§u:
                    { accessNonce, encryptedAESKey }
                                   â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚      NgÆ°á»i yÃªu cáº§u (Requestor)â”‚
               â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
               â”‚ PublicKey EC, PrivateKey      â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
        DÃ¹ng privateKey + publicKey bÃªn kia Ä‘á»ƒ tÃ­nh sharedKey
        sharedKey = SHA256(ECDH + nonce)
                                   â”‚
                  Giáº£i mÃ£ aesKey = AES.decrypt(encryptedAESKey, sharedKey)
                                   â–¼
                            Truy cáº­p file gá»‘c

Thu há»“i quyá»n? âŒ â†’ XoÃ¡ accessNonce Ä‘Ã³ khá»i backend â†’ KhÃ´ng ai giáº£i mÃ£ láº¡i Ä‘Æ°á»£c


*/

ğŸ§  Giáº£i thÃ­ch ngáº¯n gá»n:
RSA lÃ  há»‡ máº­t mÃ£ báº¥t Ä‘á»‘i xá»©ng há»— trá»£:

âœ… MÃ£ hÃ³a báº±ng publicKey â†’ Giáº£i mÃ£ báº±ng privateKey

âœ… Hoáº·c kÃ½ báº±ng privateKey â†’ XÃ¡c minh báº±ng publicKey

Elliptic Curve Cryptography (ECC) (vd: secp256k1, curve25519) láº¡i hoáº¡t Ä‘á»™ng theo cÃ¡ch khÃ¡c:

ECC khÃ´ng cÃ³ cÆ¡ cháº¿ mÃ£ hÃ³a/giáº£i mÃ£ trá»±c tiáº¿p nhÆ° RSA

MÃ  nÃ³ dÃ¹ng cho:

âœ… ECDSA: Chá»¯ kÃ½ sá»‘

âœ… ECDH: Táº¡o shared key (key exchange)

ğŸ§© Váº­y EC dÃ¹ng Ä‘á»ƒ lÃ m gÃ¬ trong há»‡ thá»‘ng cá»§a báº¡n?
Trong mÃ´ hÃ¬nh báº¡n Ä‘ang xÃ¢y:

âœ… RSA dÃ¹ng Ä‘á»ƒ:

MÃ£ hÃ³a AES key gá»‘c â†’ LÆ°u trong metadata NFT (publicKey chá»§ sá»Ÿ há»¯u)

âœ… EC (ECDH) dÃ¹ng Ä‘á»ƒ:

Khi cáº¥p quyá»n truy cáº­p: Táº¡o sharedKey giá»¯a 2 bÃªn (dÃ¹ng Ä‘á»ƒ mÃ£ hÃ³a láº¡i AES key gá»‘c)

CÃ³ thá»ƒ thu há»“i: Báº±ng cÃ¡ch chá»‰ há»§y nonce â†’ khÃ´ng cÃ²n dÃ¹ng Ä‘Æ°á»£c sharedKey Ä‘Ã³ ná»¯a
